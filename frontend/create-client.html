<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Create Client</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #f7f8fb;
        --card: #ffffff;
        --text: #1b1f23;
        --muted: #6b7280;
        --accent: #2563eb;
        --border: #e5e7eb;
        --danger: #dc2626;
        --shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg);
        color: var(--text);
      }

      header {
        background: linear-gradient(135deg, #1d4ed8, #3b82f6);
        color: #fff;
        padding: 16px;
      }

      header h1 {
        margin: 0;
        font-size: 26px;
        font-weight: 700;
      }

      .header-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
      }

      .container {
        width: 100%;
        max-width: 1500px;
        margin: 0 auto;
        padding: 24px 16px 40px;
        display: grid;
        gap: 18px;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        box-shadow: var(--shadow);
      }

      .card h2 {
        margin: 0 0 12px 0;
        font-size: 18px;
        color: var(--accent);
      }

      .card h3 {
        margin: 0 0 8px 0;
        font-size: 16px;
        color: var(--accent);
      }

      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
      }

      .grid-2-address {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px;
      }

      @media (max-width: 900px) {
        .row {
          grid-template-columns: 1fr;
        }

        .header-bar {
          flex-direction: column;
          align-items: flex-start;
        }
      }

      label {
        display: block;
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 6px;
      }

      .required {
        color: var(--danger);
        font-weight: 700;
        margin-left: 4px;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 10px;
        font-size: 14px;
        background: #fff;
        transition:
          border-color 0.2s ease,
          box-shadow 0.2s ease;
      }

      input:focus,
      select:focus,
      textarea:focus {
        border-color: #c7d2fe;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        outline: none;
      }

      input[readonly] {
        background: #f8fafc;
        border-color: #e5e7eb;
        color: var(--text);
      }

      .input-group {
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: stretch;
        border: 1px solid var(--border);
        border-radius: 10px;
        overflow: hidden;
        background: #fff;
      }

      .input-group input {
        border: none;
        border-radius: 0;
        padding: 10px 12px;
      }

      .input-group button {
        border: none;
        border-left: 1px solid var(--border);
        padding: 0 12px;
        background: #eef2ff;
        color: var(--accent);
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }

      .input-group button:hover {
        background: #e0e7ff;
      }

      textarea {
        min-height: 90px;
        resize: vertical;
      }

      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
      }

      .muted {
        color: var(--muted);
        font-size: 12px;
      }

      .actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
      }

      .btn {
        border: none;
        border-radius: 10px;
        padding: 10px 16px;
        min-height: 40px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        appearance: none;
        transition:
          transform 0.08s ease,
          box-shadow 0.2s ease,
          background 0.2s ease;
      }

      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 12px rgba(37, 99, 235, 0.18);
      }

      .btn:disabled,
      .btn[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
      }

      .btn-primary {
        background: var(--accent);
        color: #fff;
      }

      .btn-secondary {
        background: #e5e7eb;
        color: #111827;
      }

      .btn-danger {
        background: var(--danger);
        color: #fff;
      }

      .btn-danger:hover {
        background: #b91c1c;
        box-shadow: 0 6px 12px rgba(220, 38, 38, 0.2);
      }

      .btn-secondary:hover {
        background: #d9e0e8;
        box-shadow: 0 6px 12px rgba(148, 163, 184, 0.35);
      }

      .btn-outline {
        background: #fff;
        color: var(--accent);
        border: 1px solid var(--accent);
      }

      .btn-outline:hover {
        background: #eef2ff;
        box-shadow: 0 6px 12px rgba(37, 99, 235, 0.12);
      }

      .tag {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        background: #eef2ff;
        color: #1e3a8a;
        font-size: 12px;
        margin-right: 6px;
      }

      .section-note {
        font-size: 12px;
        color: var(--muted);
        margin-top: -6px;
        margin-bottom: 8px;
      }

      .wizard-steps {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 10px;
        align-items: center;
      }

      .wizard-connector {
        flex: 1;
        height: 3px;
        background: #dbe7ff;
        border-radius: 999px;
        min-width: 28px;
        position: relative;
        top: 0;
      }

      .wizard-connector.active {
        background: var(--accent);
      }

      .wizard-step-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 999px;
        background: transparent;
        color: #1e3a8a;
        font-size: 12px;
        font-weight: 600;
        border: 1px solid #c7d2fe;
      }

      .wizard-step-pill.active {
        background: transparent;
        border-color: var(--accent);
        color: var(--accent);
        box-shadow: 0 6px 14px rgba(37, 99, 235, 0.2);
        transform: translateY(-1px);
      }

      .wizard-step-pill.active .step-index {
        background: var(--accent);
        color: #fff;
      }

      .wizard-step-pill .step-index {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: #e0e7ff;
        color: inherit;
        font-size: 11px;
      }

      .wizard-step {
        display: none;
      }

      .wizard-step.active {
        display: block;
      }

      .wizard-step.card {
        border-left: 4px solid #dbeafe;
      }

      .wizard-step.card.active {
        border-left-color: var(--accent);
        box-shadow: 0 12px 28px rgba(37, 99, 235, 0.12);
      }

      .wizard-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        justify-content: space-between;
        align-items: center;
      }

      .wizard-actions .right {
        display: flex;
        gap: 12px;
      }

      .action-card {
        background: transparent;
        border: none;
        box-shadow: none;
        padding: 0;
        margin-top: 12px;
      }

      .wizard-shell {
        background: transparent;
        border: none;
        box-shadow: none;
        padding: 0;
      }

      .checkbox-row {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 10px;
      }

      .checkbox-row input[type="checkbox"] {
        width: 16px;
        height: 16px;
        accent-color: var(--accent);
      }

      .hidden {
        display: none;
      }

      .secondary-address-panel {
        background: #f8fafc;
        border: 1px dashed #cbd5f5;
        border-radius: 12px;
        padding: 12px;
      }

      .table-wrap {
        overflow-x: auto;
      }

      .bank-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      .bank-table th,
      .bank-table td {
        text-align: left;
        padding: 10px;
        border-bottom: 1px solid var(--border);
      }

      .bank-table th {
        color: var(--muted);
        font-weight: 600;
        background: #f8fafc;
      }

      .service-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 12px;
      }

      .service-item {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        display: grid;
        gap: 8px;
        background: #fff;
        transition:
          box-shadow 0.2s ease,
          transform 0.08s ease;
      }

      .service-item:hover {
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
        transform: translateY(-1px);
      }

      .service-item.selected {
        border-color: #93c5fd;
        background: #f8fbff;
      }

      .service-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .service-title {
        font-weight: 600;
        font-size: 14px;
      }

      .service-code {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 2px 8px;
        border-radius: 999px;
        background: #eef2ff;
        color: #1e3a8a;
        font-size: 12px;
      }

      .service-meta {
        display: grid;
        gap: 6px;
        font-size: 12px;
        color: var(--muted);
      }

      .service-meta strong {
        color: var(--text);
        font-weight: 600;
      }

      .service-select-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        background: #eef2ff;
        color: var(--accent);
        font-size: 12px;
        font-weight: 600;
      }

      .service-item.selected .service-select-pill {
        background: var(--accent);
        color: #fff;
      }

      .service-selection {
        display: grid;
        gap: 12px;
        margin-top: 16px;
      }

      .service-accordion {
        padding: 0;
        overflow: hidden;
      }

      .service-accordion-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        cursor: pointer;
        background: #fff;
      }

      .service-accordion-header h3 {
        margin: 0;
        font-size: 15px;
        font-weight: 700;
        color: var(--text);
      }

      .service-accordion-toggle {
        border: none;
        background: #eef2ff;
        color: var(--accent);
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
      }

      .service-accordion-body {
        padding: 0 16px 16px 16px;
        border-top: 1px solid var(--border);
        display: none;
      }

      .service-accordion.open .service-accordion-body {
        display: block;
      }

      .service-extra {
        margin-top: 16px;
        border: 1px dashed var(--border);
        border-radius: 12px;
        padding: 12px;
        background: #f8fafc;
      }

      .service-extra-title {
        font-size: 13px;
        font-weight: 700;
        color: var(--accent-strong);
        text-transform: uppercase;
        letter-spacing: 0.4px;
        margin-bottom: 10px;
      }

      .contact-list {
        display: grid;
        gap: 10px;
        margin-top: 8px;
      }

      .contact-card {
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px;
        background: #fff;
      }

      .contact-card .contact-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 8px;
      }

      .contact-card .contact-title {
        font-size: 13px;
        font-weight: 600;
        color: var(--muted);
      }

      .document-list {
        margin-top: 8px;
      }

      .doc-list {
        display: grid;
        gap: 10px;
      }

      .doc-item {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        background: #fff;
        display: grid;
        gap: 10px;
      }

      .doc-item-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .doc-icon {
        width: 32px;
        height: 32px;
        border-radius: 10px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: #eef2ff;
        color: var(--accent);
        font-weight: 700;
        font-size: 12px;
      }

      .doc-fields {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px;
      }

      .readonly-field {
        padding: 10px 12px;
        border: 1px solid #eef2f7;
        border-radius: 10px;
        background: #f8fafc;
        font-size: 14px;
        color: var(--text);
      }

      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
        z-index: 999;
      }

      .modal-backdrop.open {
        display: flex;
      }

      .modal {
        background: #fff;
        border-radius: 16px;
        width: 100%;
        max-width: 460px;
        box-shadow: 0 20px 50px rgba(15, 23, 42, 0.2);
        padding: 20px;
      }

      .modal h3 {
        margin: 0 0 6px 0;
        font-size: 18px;
      }

      .modal p {
        margin: 0 0 16px 0;
        color: var(--muted);
        font-size: 14px;
      }

      .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }

      @media (max-width: 900px) {
        .row {
          grid-template-columns: 1fr;
        }

        .header-bar {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-bar">
        <div>
          <h1>Create New Client</h1>
        </div>
        <button class="btn btn-outline" type="button" id="backToListBtn">
          Back to List
        </button>
      </div>
    </header>

    <main class="container">
      <form id="clientForm">
          <section class="card wizard-shell">
            <div class="wizard-steps" id="wizardSteps">
              <span class="wizard-step-pill" data-step-pill="0">
                <span class="step-index">1</span> Client
              </span>
              <span class="wizard-connector" data-step-connector="0"></span>
              <span class="wizard-step-pill" data-step-pill="1">
                <span class="step-index">2</span> Owner
              </span>
              <span class="wizard-connector" data-step-connector="1"></span>
              <span class="wizard-step-pill" data-step-pill="2">
                <span class="step-index">3</span> Bank Accounts
              </span>
              <span class="wizard-connector" data-step-connector="2"></span>
              <span class="wizard-step-pill" data-step-pill="3">
                <span class="step-index">4</span> Service
              </span>
            </div>
          </section>

          <section class="card wizard-step" data-step="0">
            <h2>Client Information</h2>
            <div class="grid-2">
              <div>
                <label for="cif">CIF<span class="required">*</span></label>
                <div class="input-group">
                  <input id="cif" name="cif" />
                  <button
                    type="button"
                    id="cifLookupBtn"
                    aria-label="Search CIF"
                  >
                    üîç
                  </button>
                </div>
              </div>
              <div>
                <label for="clientName"
                  >Name<span class="required">*</span></label
                >
                <input id="clientName" name="clientName" />
              </div>
              <div>
                <label for="regNo"
                  >Company Registration No<span class="required">*</span></label
                >
                <input id="regNo" name="regNo" readonly />
              </div>
              <div>
                <label for="orgSector"
                  >Organization Sector<span class="required">*</span></label
                >
                <select id="orgSector" name="orgSector">
                  <option value="">Select organization sector</option>
                  <option>Private</option>
                  <option>Public</option>
                  <option>Government</option>
                  <option>Non-Profit</option>
                </select>
              </div>
              <div>
                <label for="businessIndustry"
                  >Business Industry<span class="required">*</span></label
                >
                <select id="businessIndustry" name="businessIndustry">
                  <option value="">Select industry</option>
                  <option>Manufacturing</option>
                  <option>Retail</option>
                  <option>Services</option>
                  <option>Technology</option>
                  <option>Finance</option>
                  <option>Healthcare</option>
                  <option>Education</option>
                  <option>Agriculture</option>
                  <option>Construction</option>
                  <option>Hospitality</option>
                  <option>Logistics</option>
                  <option>Other</option>
                </select>
              </div>
              <div>
                <label for="businessSector"
                  >Business Sector<span class="required">*</span></label
                >
                <select id="businessSector" name="businessSector">
                  <option value="">Select sector</option>
                  <option>Agriculture & Forestry</option>
                  <option>Mining & Quarrying</option>
                  <option>Manufacturing</option>
                  <option>Electricity, Gas & Utilities</option>
                  <option>Construction</option>
                  <option>Wholesale & Retail Trade</option>
                  <option>Transportation & Storage</option>
                  <option>Accommodation & Food Services</option>
                  <option>Information & Communication</option>
                  <option>Financial & Insurance Activities</option>
                  <option>Real Estate</option>
                  <option>Professional, Scientific & Technical</option>
                  <option>Administrative & Support Services</option>
                  <option>Public Administration & Defense</option>
                  <option>Education</option>
                  <option>Human Health & Social Work</option>
                  <option>Arts, Entertainment & Recreation</option>
                  <option>Other Services</option>
                </select>
              </div>
            </div>

            <div style="margin-top: 18px">
              <h3>Contact</h3>
              <div class="grid-2">
                <div>
                  <label for="companyPhone"
                    >Phone<span class="required">*</span></label
                  >
                  <input id="companyPhone" name="companyPhone" />
                </div>
                <div>
                  <label for="companyEmail"
                    >Email<span class="required">*</span></label
                  >
                  <input id="companyEmail" name="companyEmail" type="email" />
                </div>
                <div>
                  <label for="companyWebsite"
                    >Website<span class="required">*</span></label
                  >
                  <input id="companyWebsite" name="companyWebsite" />
                </div>
              </div>
            </div>

            <div style="margin-top: 18px">
              <h3>Company Address</h3>
              <div class="grid-2">
                <div>
                  <label for="companyHouse">House/Building Number</label>
                  <input id="companyHouse" name="companyHouse" />
                </div>
                <div>
                  <label for="companyStreet">Street</label>
                  <input id="companyStreet" name="companyStreet" />
                </div>
                <div>
                  <label for="companyTownship">Township</label>
                  <input id="companyTownship" name="companyTownship" />
                </div>
                <div>
                  <label for="companyState">State</label>
                  <input id="companyState" name="companyState" />
                </div>
              </div>
            </div>
            <div style="margin-top: 18px">
              <h2>Bank Customer Information</h2>
              <div class="grid-2">
                <div>
                  <label for="bankCustomerName"
                    >Name<span class="required">*</span></label
                  >
                  <input
                    id="bankCustomerName"
                    name="bankCustomerName"
                    readonly
                  />
                </div>
                <div>
                  <label for="bankCustomerDob"
                    >Date of Birth<span class="required">*</span></label
                  >
                  <input
                    id="bankCustomerDob"
                    name="bankCustomerDob"
                    type="date"
                    readonly
                  />
                </div>
                <div>
                  <label for="bankCustomerPhone"
                    >Phone<span class="required">*</span></label
                  >
                  <input
                    id="bankCustomerPhone"
                    name="bankCustomerPhone"
                    readonly
                  />
                </div>
                <div>
                  <label for="bankCustomerIdType"
                    >ID Type<span class="required">*</span></label
                  >
                  <input
                    id="bankCustomerIdType"
                    name="bankCustomerIdType"
                    readonly
                  />
                </div>
                <div>
                  <label for="bankCustomerIdValue"
                    >ID Value<span class="required">*</span></label
                  >
                  <input
                    id="bankCustomerIdValue"
                    name="bankCustomerIdValue"
                    readonly
                  />
                </div>
              </div>
            </div>
          </section>

          <section class="card wizard-step" data-step="1">
            <h2>Owner Details</h2>
            <div class="grid-2">
              <div>
                <label for="ownerName"
                  >Name<span class="required">*</span></label
                >
                <input id="ownerName" name="ownerName" />
              </div>
              <div>
                <label for="ownerDob"
                  >Date of Birth<span class="required">*</span></label
                >
                <input id="ownerDob" name="ownerDob" type="date" />
              </div>
              <div>
                <label for="ownerPhone"
                  >Phone<span class="required">*</span></label
                >
                <input id="ownerPhone" name="ownerPhone" />
              </div>
              <div>
                <label for="ownerIdType"
                  >ID Type<span class="required">*</span></label
                >
                <select id="ownerIdType" name="ownerIdType">
                  <option value="">Select ID type</option>
                  <option value="NRC">NRC</option>
                  <option value="Passport">Passport</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div>
                <label for="ownerIdValue"
                  >ID Value<span class="required">*</span></label
                >
                <input id="ownerIdValue" name="ownerIdValue" />
              </div>
            </div>

            <div style="margin-top: 18px">
              <h3>Address</h3>
              <div class="grid-2">
                <div>
                  <label for="primaryHouse">House/Building Number</label>
                  <input id="primaryHouse" name="primaryHouse" />
                </div>
                <div>
                  <label for="primaryStreet">Street</label>
                  <input id="primaryStreet" name="primaryStreet" />
                </div>
                <div>
                  <label for="primaryTownship">Township</label>
                  <input id="primaryTownship" name="primaryTownship" />
                </div>
                <div>
                  <label for="primaryState">State</label>
                  <input id="primaryState" name="primaryState" />
                </div>
              </div>
              <div style="margin-top: 12px">
                <label class="checkbox-row">
                  <input type="checkbox" id="secondaryAddressToggle" /> Add
                  secondary address
                </label>
                <div
                  id="secondaryAddressWrapper"
                  class="secondary-address-panel hidden"
                >
                  <div class="section-note">Secondary Address</div>
                  <div class="grid-2-address">
                    <div>
                      <label for="secondaryHouse">House/Building Number</label>
                      <input id="secondaryHouse" name="secondaryHouse" />
                    </div>
                    <div>
                      <label for="secondaryStreet">Street</label>
                      <input id="secondaryStreet" name="secondaryStreet" />
                    </div>
                    <div>
                      <label for="secondaryTownship">Township</label>
                      <input id="secondaryTownship" name="secondaryTownship" />
                    </div>
                    <div>
                      <label for="secondaryState">State</label>
                      <input id="secondaryState" name="secondaryState" />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <section class="card wizard-step" data-step="2">
            <h2>Bank Accounts</h2>
            <div class="section-note" id="bankAccountsEmpty">
              No bank accounts loaded yet.
            </div>
            <div class="table-wrap hidden" id="bankAccountsWrap">
              <table class="bank-table">
                <thead>
                  <tr>
                    <th style="width: 45%">Account Number</th>
                    <th style="width: 20%">Currency</th>
                    <th style="width: 35%">Priority</th>
                  </tr>
                </thead>
                <tbody id="bankAccounts"></tbody>
              </table>
            </div>
          </section>

          <section class="card wizard-step" data-step="3">
            <h2>Service Subscription</h2>
            <div class="section-note">
              Subscribe to services and provide details for each selection.
            </div>
            <div
              class="service-list"
              id="serviceList"
              style="margin-bottom: 16px"
            ></div>
            <div class="service-selection" id="selectedServices"></div>
          </section>

          <section class="card action-card">
            <div class="wizard-actions">
              <div>
                <button class="btn btn-secondary" type="button" id="prevBtn">
                  Back
                </button>
              </div>
              <div class="right">
                <button class="btn btn-danger" type="reset">Reset</button>
                <button class="btn btn-outline" type="button" id="nextBtn">
                  Next
                </button>
                <button class="btn btn-primary" type="submit" id="submitBtn">
                  Create Client
                </button>
              </div>
            </div>
          </section>
        </form>
      </main>
    </div>

    <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true">
        <h3 id="modalTitle">Title</h3>
        <p id="modalMessage">Message</p>
        <div class="modal-actions" id="modalActions"></div>
      </div>
    </div>

    <script>
      const form = document.getElementById("clientForm");
      const backToListBtn = document.getElementById("backToListBtn");
      const cifInput = document.getElementById("cif");
      const cifLookupBtn = document.getElementById("cifLookupBtn");
      const modalBackdrop = document.getElementById("modalBackdrop");
      const modalTitle = document.getElementById("modalTitle");
      const modalMessage = document.getElementById("modalMessage");
      const modalActions = document.getElementById("modalActions");
      const steps = Array.from(document.querySelectorAll(".wizard-step"));
      const stepPills = Array.from(
        document.querySelectorAll("[data-step-pill]"),
      );
      const stepConnectors = Array.from(
        document.querySelectorAll("[data-step-connector]"),
      );
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");
      const submitBtn = document.getElementById("submitBtn");
      const secondaryAddressToggle = document.getElementById(
        "secondaryAddressToggle",
      );
      const secondaryAddressWrapper = document.getElementById(
        "secondaryAddressWrapper",
      );
      const bankAccountsContainer = document.getElementById("bankAccounts");
      const bankAccountsWrap = document.getElementById("bankAccountsWrap");
      const bankAccountsEmpty = document.getElementById("bankAccountsEmpty");
      const serviceListBody = document.getElementById("serviceList");
      const selectedServicesContainer =
        document.getElementById("selectedServices");
      let availableServices = [];
      let currentStep = 0;
      let autoSaveInProgress = false;
      let currentDraftId = "";

      const showStep = (index) => {
        currentStep = Math.max(0, Math.min(index, steps.length - 1));
        steps.forEach((step, idx) => {
          step.classList.toggle("active", idx === currentStep);
        });
        stepPills.forEach((pill, idx) => {
          pill.classList.toggle("active", idx === currentStep);
        });
        stepConnectors.forEach((connector, idx) => {
          connector.classList.toggle("active", idx < currentStep);
        });

        prevBtn.disabled = currentStep === 0;
        nextBtn.style.display =
          currentStep === steps.length - 1 ? "none" : "inline-flex";
        submitBtn.style.display =
          currentStep === steps.length - 1 ? "inline-flex" : "none";

        const activeStep = steps[currentStep];
        if (activeStep) {
          activeStep.scrollIntoView({ behavior: "smooth", block: "start" });
        }

        if (currentStep === 3) {
          updatePayAdvanceDetails();
        }
      };

      const getValue = (id) => {
        const el = document.getElementById(id);
        return el ? el.value.trim() : "";
      };

      const setValue = (id, value) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.value = value ?? "";
      };

      const generateShortCode = (serviceCode, cif) => {
        const base = (cif || "0000").toString().slice(-4);
        const rand = Math.random().toString(36).slice(2, 6).toUpperCase();
        return `${serviceCode || "SRV"}-${base}-${rand}`;
      };

      const hasCifConflict = async (cif) => {
        try {
          const res = await fetch("/api/clients");
          const clients = await res.json();
          return Array.isArray(clients)
            ? clients.some((entry) => entry?.client?.cif === cif)
            : false;
        } catch (_) {
          return false;
        }
      };

      const populateFromCif = (cif) => {
        fetch(`/api/cif/${encodeURIComponent(cif)}`)
          .then((res) => res.json())
          .then((payload) => {
            if (!payload.ok) {
              throw new Error(payload.message || "CIF not found");
            }

            Object.entries(payload.data || {}).forEach(([key, value]) => {
              if (
                [
                  "organizationSector",
                  "businessIndustry",
                  "businessSector",
                ].includes(key)
              ) {
                return;
              }
              setValue(key, value);
            });

            setValue("orgSector", "");
            setValue("businessIndustry", "");
            setValue("businessSector", "");

            if (bankAccountsContainer) {
              bankAccountsContainer.innerHTML = "";
              if (Array.isArray(payload.data?.bankAccounts)) {
                payload.data.bankAccounts.forEach((account) => {
                  createBankAccountRow(account);
                });
              }
              if (bankAccountsWrap) {
                const hasAccounts = !!payload.data?.bankAccounts?.length;
                bankAccountsWrap.classList.toggle("hidden", !hasAccounts);
                if (bankAccountsEmpty) {
                  bankAccountsEmpty.classList.toggle("hidden", hasAccounts);
                }
              }
              updateDebitAccountOptions();
              updatePayAdvanceDetails();
            }

            saveDraft();
          })
          .catch((error) => {
            openModal({
              title: "CIF not found",
              message:
                error.message ||
                "No predefined data found for this CIF. Try 242001260.",
              actions: [{ label: "Okay", variant: "btn-primary" }],
            });
          });
      };

      const loadServiceList = () => {
        if (!serviceListBody) return;
        fetch("/api/services")
          .then((res) => res.json())
          .then((payload) => {
            if (!payload.ok) {
              throw new Error(payload.message || "Failed to load services");
            }
            availableServices = payload.data || [];
            const cards = availableServices
              .map(
                (service) => `
                  <div class="service-item" data-service-item data-service-code="${
                    service.serviceCode || ""
                  }">
                    <div class="service-top">
                      <div>
                        <div class="service-title">${
                          service.serviceName || "Service"
                        }</div>
                        <span class="service-code">${
                          service.serviceCode || "-"
                        }</span>
                      </div>
                      <span class="service-select-pill">Subscribe</span>
                    </div>
                  </div>
                `,
              )
              .join("");
            serviceListBody.innerHTML = cards;
          })
          .catch(() => {
            serviceListBody.innerHTML = "";
          });
      };

      const getBankAccountOptions = () => {
        return Array.from(document.querySelectorAll("[data-bank-account-row]"))
          .map((row) => ({
            accountNumber: row.dataset.accountNumber || "",
            currency: row.dataset.currency || "",
            priority: row.querySelector("[data-account-priority]")?.value || "",
          }))
          .filter((row) => row.accountNumber || row.currency);
      };

      const updateDebitAccountOptions = (forceDefault = false) => {
        const selects = Array.from(
          document.querySelectorAll("[data-service-debit]"),
        );
        if (!selects.length) return;

        const accounts = getBankAccountOptions();
        const defaultAccount = accounts.find(
          (account) => account.priority === "primary",
        );

        selects.forEach((select) => {
          const current = select.value;
          select.innerHTML = "";

          const placeholder = document.createElement("option");
          placeholder.value = "";
          placeholder.textContent = accounts.length
            ? "Select debit account"
            : "No accounts available";
          select.appendChild(placeholder);

          accounts.forEach((account) => {
            const option = document.createElement("option");
            option.value = account.accountNumber;
            option.textContent = `${account.accountNumber} ¬∑ ${
              account.currency || "-"
            }`;
            select.appendChild(option);
          });

          if (!forceDefault && current) {
            select.value = current;
          } else if (defaultAccount?.accountNumber) {
            select.value = defaultAccount.accountNumber;
          } else if (accounts.length) {
            select.value = accounts[0].accountNumber;
          }
        });
      };

      const setServiceCardOpen = (card, isOpen) => {
        card.classList.toggle("open", isOpen);
        const toggleBtn = card.querySelector(".service-accordion-toggle");
        if (toggleBtn) {
          toggleBtn.textContent = isOpen ? "Collapse" : "Expand";
        }
      };

      const createSelectedServiceCard = (service) => {
        if (!selectedServicesContainer) return null;
        const card = document.createElement("div");
        const isPayAdvance = Boolean(service.requiresAdditionalRegistration);
        card.className = "card service-accordion";
        card.setAttribute("data-selected-service", "");
        card.dataset.serviceCode = service.serviceCode || "";
        card.dataset.serviceName = service.serviceName || "";
        card.dataset.serviceIntermediate = service.intermediateAccount || "";
        card.innerHTML = `
          <div class="service-accordion-header" data-accordion-toggle>
            <h3>${service.serviceName || "Service"} (${
              service.serviceCode || ""
            })</h3>
            <button class="service-accordion-toggle" type="button">
              Expand
            </button>
          </div>
          <div class="service-accordion-body">
          <div class="grid-2">
            <div>
              <label>Service Code</label>
              <div class="readonly-field">${service.serviceCode || "-"}</div>
            </div>
            <div>
              <label>Service Name</label>
              <div class="readonly-field">${service.serviceName || "-"}</div>
            </div>
            <div>
              <label>Intermediate Account</label>
              <div class="readonly-field" data-service-intermediate-text>
                ${service.intermediateAccount || "-"}
              </div>
            </div>
            <div>
              <label>Product Code</label>
              <input data-service-product value="${
                service.productCode || ""
              }" />
            </div>
            <div>
              <label>Debit Account<span class="required">*</span></label>
              <select data-service-debit></select>
            </div>
          </div>
          ${
            isPayAdvance
              ? `
          <div class="service-extra" data-pay-advance-registration>
            <div class="service-extra-title">Additional Registration</div>
            <label>Pay Advance Registration</label>
            <div style="margin-top: 8px">
              <div class="section-note">Editable</div>
              <div class="grid-2">
                <div>
                  <label>Organization Name</label>
                  <input data-pay-advance-client-name />
                </div>                
                <div>
                  <label>Owner Phone</label>
                  <input data-pay-advance-owner-phone />
                </div>
                <div>
                  <label>KBZ Pay Merchant Code</label>
                  <input data-pay-advance-merchant-code />
                </div>
              </div>
            </div>
            <div style="margin-top: 8px">
              <div class="section-note">Read-only</div>
              <div class="grid-2">
                <div>
                  <label>Owner Name</label>
                  <div class="readonly-field" data-pay-advance-owner-name>-</div>
                </div>
                <div>
                  <label>Owner Id</label>
                  <div class="readonly-field" data-pay-advance-owner-id>-</div>
                </div>
              </div>
            </div>
            <div style="margin-top: 12px" data-documents-section>
              <label>Documents (Required)</label>
              <div class="document-list hidden" data-documents-wrap>
                <div class="doc-list" data-service-documents></div>
              </div>
              <div style="margin-top: 8px">
                <button
                  class="btn btn-outline"
                  type="button"
                  data-add-document
                >
                  Add Document
                </button>
              </div>
            </div>
          </div>
          `
              : ""
          }
          <div style="margin-top: 14px">
            <label>Contact Persons</label>
            <div class="contact-list" data-service-contacts></div>
            <div style="margin-top: 8px">
              <button
                class="btn btn-outline"
                type="button"
                data-add-contact
              >
                Add Contact Person
              </button>
            </div>
          </div>
          </div>
        `;
        const toggle = card.querySelector("[data-accordion-toggle]");
        const toggleBtn = card.querySelector(".service-accordion-toggle");
        if (toggle && toggleBtn) {
          toggle.addEventListener("click", () => {
            const isOpen = card.classList.toggle("open");
            toggleBtn.textContent = isOpen ? "Collapse" : "Expand";
          });
        }

        const documentsWrap = card.querySelector("[data-documents-wrap]");
        const documentsContainer = card.querySelector(
          "[data-service-documents]",
        );
        const addDocumentBtn = card.querySelector("[data-add-document]");
        const documentTypes = [
          "Business Registration",
          "Board Resolution",
          "ID Card",
          "Power of Attorney",
          "Company Profile",
          "Service Agreement",
          "Other",
        ];

        const addDocumentRow = () => {
          if (!documentsContainer) return;
          const row = document.createElement("div");
          row.className = "document-row";
          const options = documentTypes
            .map((type) => `<option value="${type}">${type}</option>`)
            .join("");
          row.innerHTML = `
            <div class="doc-item">
              <div class="doc-item-header">
                <span class="doc-icon">PDF</span>
                <button class="btn btn-secondary" type="button" data-remove-document>
                  Remove
                </button>
              </div>
              <div class="doc-fields">
                <div>
                  <label>Document Type</label>
                  <select data-document-type>
                    <option value="">Select type</option>
                    ${options}
                  </select>
                </div>
                <div>
                  <label>Upload File</label>
                  <input type="file" data-document-file />
                </div>
              </div>
            </div>
          `;
          row
            .querySelector("[data-remove-document]")
            .addEventListener("click", () => {
              row.remove();
              if (documentsWrap) {
                documentsWrap.classList.toggle(
                  "hidden",
                  !documentsContainer.children.length,
                );
              }
            });
          documentsContainer.appendChild(row);
          if (documentsWrap) {
            documentsWrap.classList.remove("hidden");
          }
        };

        if (addDocumentBtn) {
          addDocumentBtn.addEventListener("click", addDocumentRow);
        }

        const contactsContainer = card.querySelector("[data-service-contacts]");
        const addContactBtn = card.querySelector("[data-add-contact]");
        const addContactRow = () => {
          if (!contactsContainer) return;
          const row = document.createElement("div");
          row.className = "contact-card";
          row.innerHTML = `
            <div class="contact-header">
              <span class="contact-title">Contact Person</span>
              <button class="btn btn-secondary" type="button" data-remove-contact>
                Remove
              </button>
            </div>
            <div class="row">
              <div>
                <label>Name</label>
                <input data-contact-name />
              </div>
              <div>
                <label>Email</label>
                <input data-contact-email />
              </div>
            </div>
            <div class="row" style="margin-top: 10px">
              <div>
                <label>Phone</label>
                <input data-contact-phone />
              </div>
              <div>
                <label>Remark</label>
                <input data-contact-remark />
              </div>
            </div>
          `;
          row
            .querySelector("[data-remove-contact]")
            .addEventListener("click", () => {
              row.remove();
            });
          contactsContainer.appendChild(row);
        };

        if (addContactBtn) {
          addContactBtn.addEventListener("click", addContactRow);
        }
        selectedServicesContainer.appendChild(card);

        const payAdvanceClientNameInput = card.querySelector(
          "[data-pay-advance-client-name]",
        );
        if (payAdvanceClientNameInput) {
          payAdvanceClientNameInput.addEventListener("input", () => {
            payAdvanceClientNameInput.dataset.manual = "true";
          });
        }
        const payAdvanceMerchantCodeInput = card.querySelector(
          "[data-pay-advance-merchant-code]",
        );
        if (payAdvanceMerchantCodeInput) {
          if (service.merchantCode) {
            payAdvanceMerchantCodeInput.value = service.merchantCode;
          }
          payAdvanceMerchantCodeInput.addEventListener("input", () => {
            payAdvanceMerchantCodeInput.dataset.manual = "true";
          });
        }
        const payAdvanceOwnerPhoneInput = card.querySelector(
          "[data-pay-advance-owner-phone]",
        );
        if (payAdvanceOwnerPhoneInput) {
          payAdvanceOwnerPhoneInput.addEventListener("input", () => {
            payAdvanceOwnerPhoneInput.dataset.manual = "true";
          });
        }

        updateDebitAccountOptions();
        updatePayAdvanceDetails();
        return card;
      };

      if (serviceListBody) {
        serviceListBody.addEventListener("click", (event) => {
          const card = event.target.closest("[data-service-item]");
          if (!card || !serviceListBody.contains(card)) return;

          const code = card.dataset.serviceCode;
          if (!code) return;

          const existing = selectedServicesContainer?.querySelector(
            `[data-selected-service][data-service-code="${code}"]`,
          );

          if (existing) {
            existing.remove();
            card.classList.remove("selected");
            return;
          }

          const service = availableServices.find(
            (item) => item.serviceCode === code,
          );
          if (service) {
            const newCard = createSelectedServiceCard(service);
            if (newCard && selectedServicesContainer) {
              selectedServicesContainer
                .querySelectorAll("[data-selected-service]")
                .forEach((item) => {
                  setServiceCardOpen(item, item === newCard);
                });
              newCard.scrollIntoView({ behavior: "smooth", block: "start" });
            }
            card.classList.add("selected");
          }
        });
      }

      const updatePayAdvanceDetails = () => {
        const clientName = getValue("clientName") || "-";
        const ownerName = getValue("ownerName") || "-";
        const ownerPhone = getValue("ownerPhone") || "-";
        const ownerIdType = getValue("ownerIdType") || "-";
        const ownerIdValue = getValue("ownerIdValue") || "-";

        document
          .querySelectorAll("[data-pay-advance-registration]")
          .forEach((section) => {
            const clientNameEl = section.querySelector(
              "[data-pay-advance-client-name]",
            );
            const ownerNameEl = section.querySelector(
              "[data-pay-advance-owner-name]",
            );
            const ownerPhoneEl = section.querySelector(
              "[data-pay-advance-owner-phone]",
            );
            const ownerIdEl = section.querySelector(
              "[data-pay-advance-owner-id]",
            );

            if (clientNameEl) {
              const isManual = clientNameEl.dataset.manual === "true";
              if (!isManual) {
                clientNameEl.value = clientName;
              }
            }
            if (ownerNameEl) ownerNameEl.textContent = ownerName;
            if (ownerPhoneEl) {
              const isManual = ownerPhoneEl.dataset.manual === "true";
              if (!isManual) {
                ownerPhoneEl.value = ownerPhone;
              }
            }
            if (ownerIdEl)
              ownerIdEl.textContent = `${ownerIdType} ${ownerIdValue}`.trim();
          });
      };

      ["clientName", "ownerName", "ownerPhone", "ownerIdType", "ownerIdValue"]
        .map((id) => document.getElementById(id))
        .filter(Boolean)
        .forEach((input) => {
          input.addEventListener("input", updatePayAdvanceDetails);
          input.addEventListener("change", updatePayAdvanceDetails);
        });

      const buildClientData = () => {
        const secondaryAddress = secondaryAddressToggle?.checked
          ? {
              houseBuildingNumber: getValue("secondaryHouse"),
              street: getValue("secondaryStreet"),
              township: getValue("secondaryTownship"),
              state: getValue("secondaryState"),
            }
          : null;

        return {
          client: {
            id: currentDraftId || undefined,
            cif: getValue("cif"),
            clientName: getValue("clientName"),
            companyRegistrationNo: getValue("regNo"),
            organizationSector: getValue("orgSector"),
            businessIndustry: getValue("businessIndustry"),
            businessSector: getValue("businessSector"),
            phone: getValue("companyPhone"),
            email: getValue("companyEmail"),
            website: getValue("companyWebsite"),
            bankCustomer: {
              name: getValue("bankCustomerName"),
              dateOfBirth: getValue("bankCustomerDob"),
              phone: getValue("bankCustomerPhone"),
              idType: getValue("bankCustomerIdType"),
              idValue: getValue("bankCustomerIdValue"),
            },
            owner: {
              name: getValue("ownerName"),
              dateOfBirth: getValue("ownerDob"),
              phone: getValue("ownerPhone"),
              idType: getValue("ownerIdType"),
              idValue: getValue("ownerIdValue"),
            },
            addresses: {
              primary: {
                houseBuildingNumber: getValue("primaryHouse"),
                street: getValue("primaryStreet"),
                township: getValue("primaryTownship"),
                state: getValue("primaryState"),
              },
              company: {
                houseBuildingNumber: getValue("companyHouse"),
                street: getValue("companyStreet"),
                township: getValue("companyTownship"),
                state: getValue("companyState"),
              },
              secondary: secondaryAddress,
            },
            bankAccounts: Array.from(
              document.querySelectorAll("[data-bank-account-row]"),
            )
              .map((row) => ({
                accountNumber: row.dataset.accountNumber || "",
                currency: row.dataset.currency || "",
                priority: row
                  .querySelector("[data-account-priority]")
                  ?.value?.trim(),
              }))
              .filter((row) => row.accountNumber || row.currency),
            services: Array.from(
              document.querySelectorAll("[data-selected-service]"),
            ).map((card) => ({
              serviceCode: card.dataset.serviceCode || "",
              serviceName: card.dataset.serviceName || "",
              intermediateAccount: card.dataset.serviceIntermediate || "",
              productCode: card
                .querySelector("[data-service-product]")
                ?.value?.trim(),
              debitAccount: card
                .querySelector("[data-service-debit]")
                ?.value?.trim(),
              payAdvanceRegistration: card.querySelector(
                "[data-pay-advance-registration]",
              )
                ? {
                    shortCode: generateShortCode(
                      card.dataset.serviceCode,
                      getValue("cif"),
                    ),
                    merchantCode: card
                      .querySelector("[data-pay-advance-merchant-code]")
                      ?.value?.trim(),
                  }
                : null,
              documents: card.querySelector("[data-pay-advance-registration]")
                ? Array.from(
                    card.querySelectorAll(
                      "[data-service-documents] .document-row",
                    ),
                  )
                    .map((row) => ({
                      type: row
                        .querySelector("[data-document-type]")
                        ?.value?.trim(),
                      fileName:
                        row.querySelector("[data-document-file]")?.files?.[0]
                          ?.name || "",
                    }))
                    .filter((row) => row.type || row.fileName)
                : [],
              contactPersons: Array.from(
                card.querySelectorAll("[data-service-contacts] .contact-card"),
              )
                .map((row) => ({
                  name: row.querySelector("[data-contact-name]")?.value?.trim(),
                  email: row
                    .querySelector("[data-contact-email]")
                    ?.value?.trim(),
                  phone: row
                    .querySelector("[data-contact-phone]")
                    ?.value?.trim(),
                  remark: row
                    .querySelector("[data-contact-remark]")
                    ?.value?.trim(),
                }))
                .filter(
                  (row) => row.name || row.email || row.phone || row.remark,
                ),
            })),
            createdAt: new Date().toISOString(),
          },
        };
      };

      const saveDraft = () => {
        const cif = getValue("cif");
        if (!cif) return;
        const draftData = buildClientData();
        draftData.client.status = "draft";
        draftData.client.draftUpdatedAt = new Date().toISOString();

        return fetch("/api/clients/draft", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(draftData),
        })
          .then((res) => res.json())
          .then((result) => {
            if (result?.id) {
              currentDraftId = result.id;
            }
          })
          .catch(() => {});
      };

      const autoSaveDraft = () => {
        if (autoSaveInProgress) return;
        autoSaveInProgress = true;
        Promise.resolve(saveDraft()).finally(() => {
          autoSaveInProgress = false;
        });
      };

      const openModal = ({ title, message, actions }) => {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modalActions.innerHTML = "";
        actions.forEach((action) => {
          const button = document.createElement("button");
          button.type = "button";
          button.className = `btn ${action.variant || "btn-secondary"}`;
          button.textContent = action.label;
          button.addEventListener("click", () => {
            closeModal();
            action.onClick?.();
          });
          modalActions.appendChild(button);
        });
        modalBackdrop.classList.add("open");
        modalBackdrop.setAttribute("aria-hidden", "false");
      };

      const closeModal = () => {
        modalBackdrop.classList.remove("open");
        modalBackdrop.setAttribute("aria-hidden", "true");
      };

      modalBackdrop.addEventListener("click", (event) => {
        if (event.target === modalBackdrop) {
          closeModal();
        }
      });

      const submitClient = () => {
        const clientData = buildClientData();
        fetch("/api/clients", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(clientData),
        })
          .then((res) => res.json())
          .then((result) => {
            if (!result.ok) throw new Error(result.message || "Save failed");
            if (result?.id) {
              currentDraftId = "";
            }
            const shortCodes = (clientData.client.services || [])
              .map((service) => service.payAdvanceRegistration?.shortCode)
              .filter(Boolean);
            form.reset();
            showStep(0);
            openModal({
              title: "Client created",
              message: shortCodes.length
                ? `The client has been saved successfully. Short code: ${shortCodes.join(", ")}.`
                : "The client has been saved successfully.",
              actions: [
                {
                  label: "Back to List",
                  variant: "btn-outline",
                  onClick: () => {
                    window.location.href = "index.html";
                  },
                },
                { label: "Create Another", variant: "btn-primary" },
              ],
            });
          })
          .catch((error) => {
            openModal({
              title: "Save failed",
              message: error.message || "Save failed.",
              actions: [{ label: "Okay", variant: "btn-primary" }],
            });
          });
      };

      form.addEventListener("submit", (event) => {
        event.preventDefault();
        openModal({
          title: "Create client",
          message: "Are you sure you want to save this client?",
          actions: [
            { label: "Cancel", variant: "btn-secondary" },
            {
              label: "Confirm",
              variant: "btn-primary",
              onClick: submitClient,
            },
          ],
        });
      });

      const createBankAccountRow = (prefill = {}) => {
        if (!bankAccountsContainer) return;
        const row = document.createElement("tr");
        row.setAttribute("data-bank-account-row", "");
        row.dataset.accountNumber = prefill.accountNumber || "";
        row.dataset.currency = prefill.currency || "";
        row.innerHTML = `
          <td>${prefill.accountNumber || "-"}</td>
          <td>${prefill.currency || "-"}</td>
          <td>
            <select data-account-priority>
              <option value="">Not set</option>
              <option value="primary">Default (Primary)</option>
            </select>
          </td>
        `;

        const prioritySelect = row.querySelector("[data-account-priority]");
        if (prioritySelect && prefill.priority) {
          prioritySelect.value = prefill.priority;
        }

        bankAccountsContainer.appendChild(row);
      };

      if (bankAccountsContainer) {
        bankAccountsContainer.addEventListener("change", (event) => {
          const target = event.target;
          if (!(target instanceof HTMLSelectElement)) return;
          if (!target.matches("[data-account-priority]")) return;
          if (!target.value) return;

          const allSelects = Array.from(
            bankAccountsContainer.querySelectorAll("[data-account-priority]"),
          );
          allSelects.forEach((select) => {
            if (select !== target && select.value === target.value) {
              select.value = "";
            }
          });

          updateDebitAccountOptions(true);
        });
      }

      form.addEventListener("reset", () => {
        if (bankAccountsContainer) {
          bankAccountsContainer.innerHTML = "";
        }
        if (bankAccountsWrap) {
          bankAccountsWrap.classList.add("hidden");
        }
        if (bankAccountsEmpty) {
          bankAccountsEmpty.classList.remove("hidden");
        }
        updateDebitAccountOptions();
      });

      if (secondaryAddressToggle && secondaryAddressWrapper) {
        secondaryAddressToggle.addEventListener("change", () => {
          secondaryAddressWrapper.classList.toggle(
            "hidden",
            !secondaryAddressToggle.checked,
          );
        });
      }

      form.addEventListener("reset", () => {
        if (secondaryAddressToggle && secondaryAddressWrapper) {
          secondaryAddressToggle.checked = false;
          secondaryAddressWrapper.classList.add("hidden");
        }
      });

      form.addEventListener("reset", () => {
        if (selectedServicesContainer) {
          selectedServicesContainer.innerHTML = "";
        }
        if (serviceListBody) {
          serviceListBody
            .querySelectorAll("[data-service-item].selected")
            .forEach((item) => item.classList.remove("selected"));
        }
      });

      backToListBtn.addEventListener("click", () => {
        window.location.href = "index.html";
      });

      cifLookupBtn.addEventListener("click", async () => {
        const cif = getValue("cif");
        if (!cif) {
          openModal({
            title: "Enter CIF",
            message: "Enter a CIF first to auto-populate. Example: 242001260.",
            actions: [{ label: "Okay", variant: "btn-primary" }],
          });
          return;
        }
        const conflict = await hasCifConflict(cif);
        if (conflict) {
          openModal({
            title: "CIF already exists",
            message:
              "A client with this CIF already exists. Please use a different CIF.",
            actions: [{ label: "Okay", variant: "btn-primary" }],
          });
          return;
        }
        populateFromCif(cif);
      });

      prevBtn.addEventListener("click", () => {
        showStep(currentStep - 1);
        autoSaveDraft();
      });

      nextBtn.addEventListener("click", () => {
        showStep(currentStep + 1);
        autoSaveDraft();
      });

      stepPills.forEach((pill) => {
        pill.addEventListener("click", () => {
          const stepIndex = Number(pill.dataset.stepPill);
          if (!Number.isNaN(stepIndex)) {
            showStep(stepIndex);
            autoSaveDraft();
          }
        });
      });

      showStep(0);
      loadServiceList();
    </script>
  </body>
</html>
