<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Client List</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #f7f8fb;
        --card: #ffffff;
        --text: #1b1f23;
        --muted: #6b7280;
        --accent: #2563eb;
        --border: #e5e7eb;
        --accent-strong: #1d4ed8;
        --success: #16a34a;
        --shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg);
        color: var(--text);
      }

      header {
        background: linear-gradient(135deg, #1d4ed8, #3b82f6);
        border-bottom: 1px solid var(--border);
        padding: 12px 16px;
        color: #fff;
      }

      header h1 {
        margin: 0 0 6px 0;
        font-size: 26px;
        font-weight: 700;
      }

      header p {
        margin: 0;
        opacity: 0.9;
      }

      .container {
        width: 100%;
        max-width: 1500px;
        margin: 0 auto;
        padding: 24px 16px 40px;
        display: grid;
        gap: 18px;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px 16px;
        box-shadow: var(--shadow);
      }

      .card h2 {
        margin: 0 0 12px 0;
        font-size: 18px;
        color: var(--accent);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      .table-wrap {
        overflow-x: auto;
      }

      th,
      td {
        text-align: left;
        padding: 10px;
        border-bottom: 1px solid var(--border);
        vertical-align: top;
      }

      th {
        color: var(--muted);
        font-weight: 600;
        background: #f8fafc;
        position: sticky;
        top: 0;
        z-index: 1;
      }

      tbody tr:hover {
        background: #f8fafc;
      }

      .muted {
        color: var(--muted);
      }

      .empty {
        text-align: center;
        color: var(--muted);
        padding: 24px 12px;
      }

      .pill {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        background: #eef2ff;
        color: #1e3a8a;
        font-size: 12px;
        margin-right: 6px;
      }

      .pill-draft {
        background: #fef3c7;
        color: #92400e;
      }

      .pill-active {
        background: #dcfce7;
        color: #166534;
      }

      .toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }

      .btn {
        border-radius: 10px;
        padding: 10px 16px;
        min-height: 40px;
        font-weight: 600;
        cursor: pointer;
        background: var(--accent);
        color: #fff;
        border: 1px solid transparent;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition:
          transform 0.08s ease,
          box-shadow 0.2s ease;
      }

      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 12px rgba(37, 99, 235, 0.18);
      }

      .btn-outline {
        background: #fff;
        color: var(--accent);
        border: 1px solid var(--accent);
      }

      .actions {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .row-actions {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .btn-danger {
        background: #dc2626;
        border-color: #dc2626;
      }

      .btn-danger:hover {
        box-shadow: 0 6px 12px rgba(220, 38, 38, 0.18);
      }

      .summary {
        font-size: 13px;
        color: #e2e8f0;
        margin-top: 6px;
      }

      .summary strong {
        color: #ffffff;
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
        z-index: 999;
      }

      .modal-backdrop.open {
        display: flex;
      }

      .modal {
        background: #fff;
        border-radius: 16px;
        width: 100%;
        max-width: 460px;
        box-shadow: 0 20px 50px rgba(15, 23, 42, 0.2);
        padding: 20px;
      }

      .modal h3 {
        margin: 0 0 6px 0;
        font-size: 18px;
      }

      .modal p {
        margin: 0 0 16px 0;
        color: var(--muted);
        font-size: 14px;
      }

      .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }

      @media (max-width: 900px) {
        .toolbar {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="toolbar">
        <div>
          <h1>Client List</h1>
          <div class="summary" id="clientSummary">Loading...</div>
        </div>
        <div class="actions">
          <a class="btn btn-outline" href="create-client.html">Create Client</a>
          <button class="btn" id="refreshBtn">Refresh</button>
        </div>
      </div>
    </header>

    <main class="container">
      <section class="card">
        <div class="table-wrap" id="tableContainer">Loading...</div>
      </section>
    </main>

    <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true">
        <h3 id="modalTitle">Title</h3>
        <p id="modalMessage">Message</p>
        <div class="modal-actions" id="modalActions"></div>
      </div>
    </div>

    <script>
      const tableContainer = document.getElementById("tableContainer");
      const refreshBtn = document.getElementById("refreshBtn");
      const clientSummary = document.getElementById("clientSummary");
      const modalBackdrop = document.getElementById("modalBackdrop");
      const modalTitle = document.getElementById("modalTitle");
      const modalMessage = document.getElementById("modalMessage");
      const modalActions = document.getElementById("modalActions");

      const openModal = ({ title, message, actions }) => {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modalActions.innerHTML = "";
        actions.forEach((action) => {
          const button = document.createElement("button");
          button.type = "button";
          button.className = `btn ${action.variant || "btn-secondary"}`;
          button.textContent = action.label;
          button.addEventListener("click", () => {
            closeModal();
            action.onClick?.();
          });
          modalActions.appendChild(button);
        });
        modalBackdrop.classList.add("open");
        modalBackdrop.setAttribute("aria-hidden", "false");
      };

      const closeModal = () => {
        modalBackdrop.classList.remove("open");
        modalBackdrop.setAttribute("aria-hidden", "true");
      };

      modalBackdrop.addEventListener("click", (event) => {
        if (event.target === modalBackdrop) {
          closeModal();
        }
      });

      const getDefaultAccount = (bankAccounts = []) => {
        if (!Array.isArray(bankAccounts) || bankAccounts.length === 0)
          return null;
        return (
          bankAccounts.find((account) => account.priority === "primary") ||
          bankAccounts[0]
        );
      };

      const renderServicePills = (services = []) => {
        if (!Array.isArray(services) || services.length === 0) return "-";
        return services
          .map((service) => {
            const name = service.serviceName || "Service";
            const code = service.serviceCode ? ` (${service.serviceCode})` : "";
            return `<span class="pill">${name}${code}</span>`;
          })
          .join(" ");
      };

      const renderTable = (clients) => {
        if (!clients.length) {
          tableContainer.innerHTML =
            '<div class="empty">No clients found.</div>';
          clientSummary.innerHTML = "Total: <strong>0</strong> clients";
          return;
        }

        const draftCount = clients.filter(
          (entry) => (entry.client?.status || "active") === "draft",
        ).length;

        const rows = clients
          .map((entry, index) => {
            const client = entry.client || {};
            const owner = client.owner || {};
            const defaultAccount = getDefaultAccount(client.bankAccounts);
            const createdAt = client.createdAt
              ? new Date(client.createdAt).toLocaleString()
              : "-";
            const clientId = client.id || "";
            const status = client.status || "active";
            const statusLabel = status === "draft" ? "Draft" : "Active";
            const statusClass =
              status === "draft" ? "pill-draft" : "pill-active";
            const primaryAction =
              status === "draft"
                ? `<a class="btn btn-outline" href="update-draft.html?id=${clientId}">Continue</a>`
                : `<a class="btn btn-outline" href="client-detail.html?id=${clientId}">Detail</a>`;
            return `
          <tr>
            <td>${index + 1}</td>
            <td>
              <strong>${client.clientName || "-"}</strong><br />
              <span class="muted">CIF: ${client.cif || "-"}</span>
            </td>
            <td><span class="pill ${statusClass}">${statusLabel}</span></td>
            <td>${client.organizationSector || "-"}</td>
            <td>
              ${client.businessIndustry || "-"}<br />
              <span class="muted">${client.businessSector || "-"}</span>
            </td>
            <td>
              ${owner.name || "-"}<br />
              <span class="muted">${owner.phone || "-"}</span>
            </td>
            <td>
              ${defaultAccount ? defaultAccount.accountNumber : "-"}<br />
              <span class="muted">${defaultAccount ? defaultAccount.currency || "" : ""}</span>
            </td>
            <td>${renderServicePills(client.services)}</td>
            <td>${createdAt}</td>
            <td>
              <div class="row-actions">
                ${primaryAction}
                <button class="btn btn-danger" data-id="${clientId}">Delete</button>
              </div>
            </td>
          </tr>
        `;
          })
          .join("");

        tableContainer.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Client Name</th>
              <th>Status</th>
              <th>Organization Sector</th>
              <th>Business</th>
              <th>Owner</th>
              <th>Default Debit Account</th>
              <th>Subscribed Services</th>
              <th>Created Date</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;
        clientSummary.innerHTML = `Total: <strong>${clients.length}</strong> client${clients.length === 1 ? "" : "s"} Â· Drafts: <strong>${draftCount}</strong>`;
      };

      const loadClients = () => {
        refreshBtn.disabled = true;
        tableContainer.textContent = "Loading...";
        clientSummary.textContent = "Loading...";
        fetch("/api/clients")
          .then((res) => res.json())
          .then((data) => {
            renderTable(Array.isArray(data) ? data : []);
          })
          .catch(() => {
            tableContainer.innerHTML =
              '<div class="empty">Failed to load clients.</div>';
          })
          .finally(() => {
            refreshBtn.disabled = false;
          });
      };

      tableContainer.addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;
        if (!target.matches("button[data-id]")) return;

        const clientId = target.dataset.id || "";
        if (!clientId) return;

        openModal({
          title: "Delete client",
          message:
            "Are you sure you want to delete this client? This action cannot be undone.",
          actions: [
            { label: "Cancel", variant: "btn-secondary" },
            {
              label: "Delete",
              variant: "btn-danger",
              onClick: () => {
                target.disabled = true;
                fetch(`/api/clients/${clientId}`, { method: "DELETE" })
                  .then((res) => res.json())
                  .then((result) => {
                    if (!result.ok)
                      throw new Error(result.message || "Delete failed");
                    loadClients();
                    openModal({
                      title: "Deleted",
                      message: "The client has been removed.",
                      actions: [{ label: "Okay", variant: "btn-primary" }],
                    });
                  })
                  .catch((error) => {
                    target.disabled = false;
                    openModal({
                      title: "Delete failed",
                      message: error.message || "Delete failed.",
                      actions: [{ label: "Okay", variant: "btn-primary" }],
                    });
                  });
              },
            },
          ],
        });
      });

      refreshBtn.addEventListener("click", loadClients);
      loadClients();
    </script>
  </body>
</html>
