<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Client Detail</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #f7f8fb;
        --card: #ffffff;
        --text: #1b1f23;
        --muted: #6b7280;
        --accent: #2563eb;
        --accent-strong: #1d4ed8;
        --border: #e5e7eb;
        --shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg);
        color: var(--text);
      }

      header {
        background: linear-gradient(135deg, #1d4ed8, #3b82f6);
        color: #fff;
        padding: 16px;
      }

      header h1 {
        margin: 0 0 4px 0;
        font-size: 26px;
        font-weight: 700;
      }

      header p {
        margin: 0;
        opacity: 0.85;
      }

      .header-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
      }

      .header-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .container {
        width: 100%;
        max-width: 1500px;
        margin: 0 auto;
        padding: 24px 16px 40px;
        display: grid;
        gap: 18px;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        box-shadow: var(--shadow);
      }

      .card h2 {
        margin: 0 0 12px 0;
        font-size: 18px;
        color: var(--accent);
      }

      .grid-2 {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 16px;
      }

      .info-tag {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 700;
        background: #eef2ff;
        color: #1e3a8a;
        margin-left: 8px;
        text-transform: uppercase;
        letter-spacing: 0.4px;
      }

      .tag-client {
        background: #e0f2fe;
        color: #0369a1;
      }

      .tag-contact {
        background: #ede9fe;
        color: #6d28d9;
      }

      .tag-bank {
        background: #dcfce7;
        color: #15803d;
      }

      .tag-owner {
        background: #fef3c7;
        color: #92400e;
      }

      .tag-address {
        background: #fee2e2;
        color: #b91c1c;
      }

      .tag-service {
        background: #e0e7ff;
        color: #4338ca;
      }

      .tabs {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 12px;
      }

      .tab-btn {
        border: 1px solid #c7d2fe;
        background: transparent;
        color: #1e3a8a;
        border-radius: 999px;
        padding: 6px 10px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition:
          transform 0.08s ease,
          box-shadow 0.2s ease;
      }

      .tab-btn.active {
        background: transparent;
        color: var(--accent);
        border-color: var(--accent);
        box-shadow: 0 6px 14px rgba(37, 99, 235, 0.2);
        transform: translateY(-1px);
      }

      .tab-section {
        display: none;
      }

      .tab-section.active {
        display: grid;
        gap: 18px;
      }

      .kv {
        display: grid;
        gap: 10px;
        font-size: 14px;
      }

      .kv-row {
        display: grid;
        grid-template-columns: 180px 1fr;
        align-items: center;
        gap: 12px;
      }

      .kv-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--muted);
      }

      .kv-value {
        font-size: 14px;
        color: var(--text);
        background: #f8fafc;
        border: 1px solid #eef2f7;
        border-radius: 10px;
        padding: 10px 12px;
      }

      .kv.compact {
        gap: 8px;
      }

      .kv.compact .kv-row {
        grid-template-columns: 140px 1fr;
      }

      .service-list {
        display: grid;
        gap: 12px;
      }

      .service-card {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        background: #fff;
      }

      .service-card h3 {
        margin: 0 0 8px 0;
        font-size: 16px;
        color: var(--accent);
      }

      .service-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 10px;
      }

      .service-tag {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        border-radius: 999px;
        background: #eef2ff;
        color: #1e3a8a;
        font-size: 12px;
        font-weight: 600;
      }

      .list-block {
        margin-top: 10px;
        border-top: 1px dashed var(--border);
        padding-top: 10px;
      }

      .list-title {
        font-size: 12px;
        font-weight: 700;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.4px;
        margin-bottom: 6px;
      }

      .doc-list {
        display: grid;
        gap: 8px;
      }

      .doc-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: #fff;
      }

      .doc-icon {
        width: 34px;
        height: 34px;
        border-radius: 10px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: #eef2ff;
        color: var(--accent);
        font-weight: 700;
        font-size: 14px;
      }

      .doc-meta {
        display: grid;
        gap: 2px;
        font-size: 13px;
      }

      .doc-title {
        font-weight: 700;
      }

      .doc-sub {
        color: var(--muted);
      }

      .table-wrap {
        overflow-x: auto;
      }

      .mini-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      .mini-table th,
      .mini-table td {
        text-align: left;
        padding: 8px 10px;
        border-bottom: 1px solid var(--border);
      }

      .mini-table th {
        color: var(--muted);
        font-weight: 600;
        background: #f8fafc;
      }

      .subsection {
        margin-top: 12px;
        border-top: 1px dashed var(--border);
        padding-top: 12px;
      }

      .subsection-title {
        font-size: 12px;
        font-weight: 700;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.4px;
        margin-bottom: 8px;
      }

      .bank-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      .bank-table th,
      .bank-table td {
        text-align: left;
        padding: 10px;
        border-bottom: 1px solid var(--border);
      }

      .bank-table th {
        color: var(--muted);
        font-weight: 600;
        background: #f8fafc;
      }

      .btn {
        border: none;
        border-radius: 10px;
        padding: 10px 16px;
        min-height: 40px;
        font-weight: 600;
        cursor: pointer;
        background: var(--accent);
        color: #fff;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        appearance: none;
        transition:
          transform 0.08s ease,
          box-shadow 0.2s ease;
      }

      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 12px rgba(37, 99, 235, 0.18);
      }

      .btn-outline {
        background: #fff;
        color: var(--accent);
        border: 1px solid var(--accent);
      }

      .btn-secondary {
        background: #e5e7eb;
        color: #111827;
        border: 1px solid #e5e7eb;
        text-decoration: none;
      }

      .btn-secondary:hover {
        background: #d9e0e8;
      }

      .muted {
        color: var(--muted);
      }

      @media (max-width: 900px) {
        .header-bar {
          flex-direction: column;
          align-items: flex-start;
        }

        .header-actions {
          width: 100%;
          justify-content: flex-start;
        }

        .grid-2 {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 640px) {
        .kv-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-bar">
        <div>
          <h1 id="clientName">Client Detail</h1>
          <p id="clientSub">Loading...</p>
        </div>
        <div class="header-actions">
          <button class="btn btn-secondary" type="button" id="backToListBtn">
            Back to List
          </button>
          <button class="btn btn-outline" type="button" id="updateClientBtn">
            Update Client
          </button>
        </div>
      </div>
    </header>

    <main class="container">
      <div class="tabs" role="tablist">
        <button class="tab-btn active" data-tab="client" type="button">
          Client
        </button>
        <button class="tab-btn" data-tab="owner" type="button">Owner</button>
        <button class="tab-btn" data-tab="bank" type="button">Bank</button>
        <button class="tab-btn" data-tab="services" type="button">
          Services
        </button>
      </div>

      <section class="tab-section active" data-tab-section="client">
        <div class="grid-2">
          <div class="card">
            <h2>
              Client Information
              <span class="info-tag tag-client">Client</span>
            </h2>
            <div class="kv" id="clientOverview"></div>
          </div>

          <div class="card">
            <h2>Contact <span class="info-tag tag-contact">Contact</span></h2>
            <div class="kv" id="companyContact"></div>
          </div>

          <div class="card">
            <h2>
              Bank Customer Information
              <span class="info-tag tag-bank">Bank</span>
            </h2>
            <div class="kv" id="bankCustomerInfo"></div>
          </div>
        </div>
        <div class="card">
          <h2>
            Company Address <span class="info-tag tag-client">Client</span>
          </h2>
          <div class="kv" id="companyAddress"></div>
        </div>
      </section>

      <section class="tab-section" data-tab-section="owner">
        <div class="grid-2">
          <div class="card">
            <h2>Owner Details <span class="info-tag tag-owner">Owner</span></h2>
            <div class="kv" id="ownerDetails"></div>
          </div>

          <div class="card">
            <h2>
              Owner Address <span class="info-tag tag-address">Address</span>
            </h2>
            <div class="kv" id="primaryAddress"></div>
            <div class="subsection" id="secondaryAddressSection">
              <div class="subsection-title">Secondary Address</div>
              <div class="kv" id="secondaryAddress"></div>
            </div>
          </div>
        </div>
      </section>

      <section class="tab-section" data-tab-section="bank">
        <div class="card">
          <h2>Bank Accounts <span class="info-tag tag-bank">Bank</span></h2>
          <div class="table-wrap">
            <table class="bank-table">
              <thead>
                <tr>
                  <th style="width: 50%">Account Number</th>
                  <th style="width: 20%">Currency</th>
                  <th style="width: 30%">Priority</th>
                </tr>
              </thead>
              <tbody id="bankAccounts"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="tab-section" data-tab-section="services">
        <div class="card">
          <h2>
            Subscribed Services
            <span class="info-tag tag-service">Service</span>
          </h2>
          <div class="service-list" id="servicesList"></div>
        </div>
      </section>
    </main>

    <script>
      const getById = (id) => document.getElementById(id);
      const renderKv = (container, entries) => {
        container.innerHTML = entries
          .map(
            ([label, value]) =>
              `<div class="kv-row"><div class="kv-label">${label}</div><div class="kv-value">${
                value || "-"
              }</div></div>`,
          )
          .join("");
      };

      const params = new URLSearchParams(window.location.search);
      const clientId = params.get("id") || "";

      const loadClient = async () => {
        try {
          const res = await fetch("/api/clients");
          const data = await res.json();
          const clients = Array.isArray(data) ? data : [];
          const entry = clients.find((item) => item?.client?.id === clientId);
          if (!entry) throw new Error("Client not found");

          const client = entry.client || {};
          const owner = client.owner || {};
          const bankCustomer = client.bankCustomer || {};
          const address = client.addresses || {};
          const services = Array.isArray(client.services)
            ? client.services
            : [];
          const bankAccounts = Array.isArray(client.bankAccounts)
            ? client.bankAccounts
            : [];

          getById("clientName").textContent =
            client.clientName || "Client Detail";
          getById("clientSub").textContent =
            `CIF: ${client.cif || "-"} Â· ${client.businessIndustry || "-"}`;

          renderKv(getById("clientOverview"), [
            ["Name", client.clientName],
            ["Company Registration No", client.companyRegistrationNo],
            ["Organization Sector", client.organizationSector],
            ["Business Industry", client.businessIndustry],
            ["Business Sector", client.businessSector],
            [
              "Created",
              client.createdAt
                ? new Date(client.createdAt).toLocaleString()
                : "-",
            ],
          ]);

          renderKv(getById("companyContact"), [
            ["Phone", client.phone],
            ["Email", client.email],
            ["Website", client.website],
          ]);

          renderKv(getById("bankCustomerInfo"), [
            ["Name", bankCustomer.name],
            ["Date of Birth", bankCustomer.dateOfBirth],
            ["Phone", bankCustomer.phone],
            ["ID Type", bankCustomer.idType],
            ["ID Value", bankCustomer.idValue],
          ]);

          renderKv(getById("ownerDetails"), [
            ["Name", owner.name],
            ["Date of Birth", owner.dateOfBirth],
            ["Phone", owner.phone],
            ["ID Type", owner.idType],
            ["ID Value", owner.idValue],
          ]);

          renderKv(getById("primaryAddress"), [
            ["House/Building Number", address.primary?.houseBuildingNumber],
            ["Street", address.primary?.street],
            ["Township", address.primary?.township],
            ["State", address.primary?.state],
          ]);

          renderKv(getById("companyAddress"), [
            ["House/Building Number", address.company?.houseBuildingNumber],
            ["Street", address.company?.street],
            ["Township", address.company?.township],
            ["State", address.company?.state],
          ]);

          const secondarySection = getById("secondaryAddressSection");
          const hasSecondary = Boolean(
            address.secondary?.houseBuildingNumber ||
            address.secondary?.street ||
            address.secondary?.township ||
            address.secondary?.state,
          );
          if (secondarySection) {
            secondarySection.style.display = hasSecondary ? "block" : "none";
          }
          if (hasSecondary) {
            renderKv(getById("secondaryAddress"), [
              ["House/Building Number", address.secondary?.houseBuildingNumber],
              ["Street", address.secondary?.street],
              ["Township", address.secondary?.township],
              ["State", address.secondary?.state],
            ]);
          }

          const bankAccountsBody = getById("bankAccounts");
          if (bankAccountsBody) {
            if (!bankAccounts.length) {
              bankAccountsBody.innerHTML =
                '<tr><td colspan="3" class="muted">No bank accounts.</td></tr>';
            } else {
              bankAccountsBody.innerHTML = bankAccounts
                .map(
                  (account) => `
                    <tr>
                      <td>${account.accountNumber || "-"}</td>
                      <td>${account.currency || "-"}</td>
                      <td>${account.priority || "-"}</td>
                    </tr>
                  `,
                )
                .join("");
            }
          }

          const servicesList = getById("servicesList");
          if (servicesList) {
            if (!services.length) {
              servicesList.innerHTML =
                '<div class="muted">No services subscribed.</div>';
            } else {
              servicesList.innerHTML = services
                .map((item) => {
                  const documents = Array.isArray(item.documents)
                    ? item.documents
                    : [];
                  const documentLines = documents.length
                    ? `
                      <div class="doc-list">
                        ${documents
                          .map(
                            (doc) => `
                              <div class="doc-item">
                                <span class="doc-icon">PDF</span>
                                <div class="doc-meta">
                                  <div class="doc-title">${
                                    doc.type || "Document"
                                  }</div>
                                  <div class="doc-sub">${
                                    doc.fileName || "No file name"
                                  }</div>
                                </div>
                              </div>
                            `,
                          )
                          .join("")}
                      </div>
                    `
                    : "";
                  const contacts = Array.isArray(item.contactPersons)
                    ? item.contactPersons
                    : [];
                  const contactTable = contacts.length
                    ? `
                      <div class="table-wrap">
                        <table class="mini-table">
                          <thead>
                            <tr>
                              <th style="width: 25%">Name</th>
                              <th style="width: 25%">Email</th>
                              <th style="width: 20%">Phone</th>
                              <th style="width: 30%">Remark</th>
                            </tr>
                          </thead>
                          <tbody>
                            ${contacts
                              .map(
                                (contact) => `
                                  <tr>
                                    <td>${contact.name || "-"}</td>
                                    <td>${contact.email || "-"}</td>
                                    <td>${contact.phone || "-"}</td>
                                    <td>${contact.remark || "-"}</td>
                                  </tr>
                                `,
                              )
                              .join("")}
                          </tbody>
                        </table>
                      </div>
                    `
                    : "-";
                  const additionalShortCode =
                    item.payAdvanceRegistration?.shortCode;
                  const additionalInfo = additionalShortCode
                    ? `<div class="kv-row"><div class="kv-label">Short Code</div><div class="kv-value">${additionalShortCode}</div></div>`
                    : "";

                  return `
                    <div class="service-card">
                      <h3>${item.serviceName || "Service"}</h3>
                      <div class="service-meta">
                        <span class="service-tag">${
                          item.serviceCode || "-"
                        }</span>
                        ${
                          additionalShortCode
                            ? `<span class="service-tag">Short code: ${additionalShortCode}</span>`
                            : ""
                        }
                      </div>
                      <div class="kv compact">
                        <div class="kv-row">
                          <div class="kv-label">Product Code</div>
                          <div class="kv-value">${item.productCode || "-"}</div>
                        </div>
                        <div class="kv-row">
                          <div class="kv-label">Debit Account</div>
                          <div class="kv-value">${item.debitAccount || "-"}</div>
                        </div>
                        ${additionalInfo}
                      </div>
                      ${
                        documentLines
                          ? `
                      <div class="list-block">
                        <div class="list-title">Documents</div>
                        <div>${documentLines}</div>
                      </div>
                      `
                          : ""
                      }
                      <div class="list-block">
                        <div class="list-title">Contact Persons</div>
                        <div>${contactTable}</div>
                      </div>
                    </div>
                  `;
                })
                .join("");
            }
          }
        } catch (error) {
          getById("clientName").textContent = "Client Detail";
          getById("clientSub").textContent =
            error.message || "Failed to load client";
        }
      };

      const backToListBtn = document.getElementById("backToListBtn");
      const updateClientBtn = document.getElementById("updateClientBtn");
      const tabButtons = Array.from(document.querySelectorAll("[data-tab]"));
      const tabSections = Array.from(
        document.querySelectorAll("[data-tab-section]"),
      );

      backToListBtn.addEventListener("click", () => {
        window.location.href = "index.html";
      });

      updateClientBtn.addEventListener("click", () => {
        window.location.href = `update-client.html?id=${clientId}`;
      });

      tabButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const target = btn.dataset.tab;
          tabButtons.forEach((item) =>
            item.classList.toggle("active", item === btn),
          );
          tabSections.forEach((section) => {
            section.classList.toggle(
              "active",
              section.dataset.tabSection === target,
            );
          });
        });
      });

      loadClient();
    </script>
  </body>
</html>
